<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <style>
        .app-version {
            position: absolute;
            top: 5px;
            left: 10px;
            font-size: 0.75rem;
            color: #6c757d; /* Cor secundária do Bootstrap */
            line-height: 1.2;
            z-index: 1050; /* Para ficar acima da maioria dos elementos */
        }
        body {
            background-color: #f8f9fa; /* Um cinza claro do Bootstrap */
        }
        .main-container {
            margin-top: 20px;
        }
        .barcode-input-area {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .current-sale-area {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 300px; /* Para dar um espaço visual */
        }
        #saleItemsList {
            list-style-type: none;
            padding-left: 0;
            max-height: 250px; /* Defina a altura máxima desejada para a lista */
            overflow-y: auto;  /* Adiciona scroll vertical apenas se necessário */
        }
        #saleItemsList li {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        #saleItemsList li:last-child {
            border-bottom: none;
        }
        .sale-total-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #343a40; /* Cor escura do Bootstrap */
        }
        .total-display {
            font-size: 2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="app-version">
        plima<br>v1.2
    </div>
    <div class="container main-container">
        <header class="text-center mb-4">
            <h1>{{ page_title }}</h1>
        </header>

        <!-- Input oculto para armazenar o ID do Ponto de Venda -->
        <input type="hidden" id="pointOfSaleId" value="{{ point_of_sale.id }}">

        <div class="row">
            <!-- Área de Entrada do Código de Barras e Lista de Produtos (se necessário) -->
            <div class="col-md-6">
                <div class="barcode-input-area">
                    <h2 class="h4">Registrar Produto</h2>
                    <div class="mb-3">
                        <label for="barcodeScanInput" class="form-label">Código de Barras / Código Interno:</label>
                        <input type="text" class="form-control form-control-lg" id="barcodeScanInput" placeholder="Leia o código de barras ou digite o código" autofocus>
                    </div>
                    <!-- Botão para Abrir Calculadora -->
                    <div class="d-grid gap-2 mb-3">
                        <!-- Alterado para ser um botão que abre um modal -->
                        <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#calculatorModal">
                            Abrir Calculadora de Troco (F3)
                        </button>
                    </div>
                    <!-- Botão de Quantidade -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button class="btn btn-secondary me-md-2" type="button" data-bs-toggle="modal" data-bs-target="#quantityModal">Quantidade (F4) (<span id="currentPendingQuantity">1</span>)</button>
                        <!-- O botão "Adicionar Produto" foi removido da interface para agilizar o fluxo. A funcionalidade continua via tecla Enter. -->
                        <button class="btn btn-primary flex-grow-1" type="button" id="addProductByCode" style="display: none;">Adicionar Produto</button>
                    </div>
                </div>

                <!-- Opcional: Área para exibir resultados de busca ou lista de produtos mais vendidos -->
                <!--
                <div class="mt-3">
                    <h4>Produtos Frequentes / Resultados da Busca:</h4>
                    <ul id="quickProductList" class="list-group">
                         Exemplo de item:
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Coca Cola - R$ 5.00
                            <button class="btn btn-sm btn-outline-success add-to-sale" data-product-id="1">Adicionar</button>
                        </li>
                    </ul>
                </div>
                -->
            </div>

            <!-- Área da Venda Atual -->
            <div class="col-md-6">
                <div class="current-sale-area">
                    <h2 class="h4">Venda Atual</h2>
                    <ul id="saleItemsList" class="mb-3">
                        <!-- Itens da venda serão adicionados aqui via JavaScript -->
                        <li class="text-muted text-center" id="emptySaleMessage">Nenhum item na venda.</li>
                    </ul>
                    <div class="sale-total-section">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5">TOTAL:</span>
                            <span class="total-display text-success">R$ <span id="saleTotal">0.00</span></span>
                        </div>
                        <button class="btn btn-success btn-lg w-100 mt-3" id="finalizeSale">Finalizar Venda (F9)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Quantidade -->
    <div class="modal fade" id="quantityModal" tabindex="-1" aria-labelledby="quantityModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="quantityModalLabel">Definir Quantidade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quantityInput" class="form-label">Quantidade:</label>
                        <input type="text" inputmode="decimal" class="form-control form-control-lg" id="quantityInput" value="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmQuantityButton">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Finalização de Venda (REESTRUTURADO) -->
    <div class="modal fade" id="finalizeSaleModal" tabindex="-1" aria-labelledby="finalizeSaleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg"> <!-- modal-lg para mais espaço -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="finalizeSaleModalLabel">Finalizar Venda - Total: R$ <span id="modalSaleTotal">0.00</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Seção para adicionar pagamentos -->
                        <div class="col-md-6">
                            <h5>Adicionar Pagamento</h5>
                            <div class="mb-3">
                                <label class="form-label">Forma de Pagamento:</label>
                                <div id="paymentMethodButtons" class="d-grid gap-2">
                                    <!-- Botões serão gerados aqui pelo Django -->
                                    {% for method in payment_methods %}
                                        <button type="button" class="btn btn-outline-primary payment-method-btn" 
                                                data-method-id="{{ method.id }}" 
                                                data-method-name="{{ method.description }}"
                                                data-requires-customer="{{ method.requires_customer|yesno:'true,false' }}">
                                            {{ method.description }}
                                        </button>
                                    {% endfor %}
                                </div>
                                <!-- Input oculto para armazenar o ID da forma de pagamento selecionada -->
                                <input type="hidden" id="selectedPaymentMethodId">
                            </div>

                            <!-- Seção de Seleção de Cliente (inicialmente oculta) -->
                            <div id="customerSelectionArea" class="mb-3" style="display: none;">
                                <hr>
                                <label for="customerSearchInput" class="form-label">Buscar Cliente:</label>
                                <input type="text" id="customerSearchInput" class="form-control" placeholder="Digite o nome do cliente...">
                                <div id="customerSearchResults" class="list-group mt-2" style="max-height: 150px; overflow-y: auto;"></div>
                                <div id="selectedCustomerDisplay" class="mt-2">
                                    <strong>Cliente Selecionado:</strong> <span id="selectedCustomerName">Nenhum</span>
                                </div>
                                <input type="hidden" id="selectedCustomerId">
                            </div>

                            <div class="mb-3">
                                <label for="paymentAmountInput" class="form-label">Valor a Pagar (R$):</label>
                                <input type="text" inputmode="decimal" class="form-control" id="paymentAmountInput" placeholder="0,00">
                            </div>
                            <button type="button" class="btn btn-primary w-100" id="addPaymentButton">Adicionar Pagamento (F9)</button>
                            <hr>
                            <div class="d-flex justify-content-between mt-2">
                                <strong>Total Pago:</strong>
                                <strong id="modalTotalPaid">R$ 0.00</strong>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <strong>Restante:</strong>
                                <strong id="modalAmountRemaining" class="text-danger">R$ 0.00</strong>
                            </div>
                        </div>

                        <!-- Seção para listar pagamentos adicionados -->
                        <div class="col-md-6">
                            <h5>Pagamentos Adicionados</h5>
                            <ul class="list-group" id="addedPaymentsList">
                                <li class="list-group-item text-muted" id="noPaymentsAddedMsg">Nenhum pagamento adicionado.</li>
                                <!-- Pagamentos serão listados aqui pelo JS -->
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelSaleFinalizationButton">Cancelar</button>
                    <button type="button" class="btn btn-success" id="confirmSaleWithPaymentsButton" disabled>Confirmar Venda (F10)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal da Calculadora -->
    <div class="modal fade" id="calculatorModal" tabindex="-1" aria-labelledby="calculatorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm"> <!-- modal-sm para uma calculadora menor -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="calculatorModalLabel">Calculadora</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Conteúdo da Calculadora (copiado de calculator_page.html) -->
                    <div class="calculator-modal-content"> <!-- Nova classe para escopo -->
                        <div id="calculatorDisplay" class="mb-3" style="background-color: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; font-size: 2em; text-align: right; overflow-x: auto; white-space: nowrap;">0</div>
                        <div class="row g-2">
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="7">7</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="8">8</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="9">9</button></div>
                            <div class="col-3"><button class="btn btn-warning w-100 calc-btn" data-action="operator" data-value="/">/</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="4">4</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="5">5</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="6">6</button></div>
                            <div class="col-3"><button class="btn btn-warning w-100 calc-btn" data-action="operator" data-value="*">*</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="1">1</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="2">2</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="3">3</button></div>
                            <div class="col-3"><button class="btn btn-warning w-100 calc-btn" data-action="operator" data-value="-">-</button></div>
                            <div class="col-3"><button class="btn btn-danger w-100 calc-btn" data-action="clear">C</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-value="0">0</button></div>
                            <div class="col-3"><button class="btn btn-secondary w-100 calc-btn" data-action="decimal" data-value=".">.</button></div>
                            <div class="col-3"><button class="btn btn-warning w-100 calc-btn" data-action="operator" data-value="+">+</button></div>
                            <div class="col-12"><button class="btn btn-primary w-100 calc-btn" data-action="calculate">=</button></div>
                        </div>
                    </div>
                    <!-- Fim do Conteúdo da Calculadora -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap JS Bundle (Popper.js incluído) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Seletores de Elementos ---
            const barcodeInput = document.getElementById('barcodeScanInput');
            const addProductButton = document.getElementById('addProductByCode');
            const saleItemsList = document.getElementById('saleItemsList');
            const saleTotalSpan = document.getElementById('saleTotal');
            const finalizeSaleButton = document.getElementById('finalizeSale');
            const emptySaleMessage = document.getElementById('emptySaleMessage');
            const quantityInput = document.getElementById('quantityInput');
            const confirmQuantityButton = document.getElementById('confirmQuantityButton');
            const currentPendingQuantitySpan = document.getElementById('currentPendingQuantity');
            const quantityModalElement = document.getElementById('quantityModal'); // Adicionado para o atalho F4
            const finalizeSaleModalElement = document.getElementById('finalizeSaleModal');
            const finalizeSaleModalInstance = finalizeSaleModalElement ? new bootstrap.Modal(finalizeSaleModalElement) : null;
            const modalSaleTotalSpan = document.getElementById('modalSaleTotal');
            const paymentAmountInput = document.getElementById('paymentAmountInput');
            const addPaymentButton = document.getElementById('addPaymentButton');
            const addedPaymentsList = document.getElementById('addedPaymentsList');
            const noPaymentsAddedMsg = document.getElementById('noPaymentsAddedMsg');
            const modalTotalPaidSpan = document.getElementById('modalTotalPaid');
            const modalAmountRemainingSpan = document.getElementById('modalAmountRemaining');
            const confirmSaleWithPaymentsButton = document.getElementById('confirmSaleWithPaymentsButton');
            const paymentMethodButtonsContainer = document.getElementById('paymentMethodButtons');
            const selectedPaymentMethodIdInput = document.getElementById('selectedPaymentMethodId');
            const paymentMethodButtons = document.querySelectorAll('.payment-method-btn');
            // --- Novos Seletores de Cliente ---
            const customerSelectionArea = document.getElementById('customerSelectionArea');
            const customerSearchInput = document.getElementById('customerSearchInput');
            const customerSearchResults = document.getElementById('customerSearchResults');
            const selectedCustomerIdInput = document.getElementById('selectedCustomerId');
            const selectedCustomerNameSpan = document.getElementById('selectedCustomerName');

            // --- Seletores da Calculadora ---
            const calculatorModalElement = document.getElementById('calculatorModal');

            // --- Dados e Estado ---
            const productsData = [ {% for product in products %}{ id: "{{ product.id }}", name: "{{ product.name|escapejs }}", price: "{{ product.price }}", internal_code: "{{ product.internal_code|escapejs }}", barcode: "{{ product.barcode|escapejs }}" }, {% endfor %} ];
            let currentSaleTotal = 0.00, saleItemsArray = [], nextSaleItemId = 1, pendingQuantity = 1, currentPaymentsArray = [], saleTotalForModal = 0;

            // --- Funções ---
            function addProductToSale(product) {
                const itemSubtotal = parseFloat(product.price) * pendingQuantity;
                const saleItemId = nextSaleItemId++;
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                listItem.setAttribute('data-sale-item-id', saleItemId);
                listItem.innerHTML = `<div><span>${product.internal_code || product.barcode}</span> | <span class="mx-1">${product.name}</span> | <span class="badge bg-info rounded-pill me-1">${pendingQuantity}x</span> | <span>R$ ${itemSubtotal.toFixed(2).replace('.', ',')}</span></div><button class="btn btn-danger btn-sm remove-sale-item-btn" data-remove-id="${saleItemId}">X</button>`;
                saleItemsArray.push({ id: saleItemId, productId: product.id, quantity: pendingQuantity, price: parseFloat(product.price), subtotal: itemSubtotal, listItemElement: listItem });
                currentSaleTotal += itemSubtotal;
                pendingQuantity = 1;
                if (quantityInput) quantityInput.value = "1";
                if (currentPendingQuantitySpan) currentPendingQuantitySpan.textContent = "1";
                barcodeInput.value = "";
                barcodeInput.focus();
                renderSaleItems();
                updateSaleTotalOnScreen();
            }

            function removeSaleItem(id) {
                const index = saleItemsArray.findIndex(item => item.id === id);
                if (index > -1) {
                    currentSaleTotal -= saleItemsArray[index].subtotal;
                    saleItemsArray.splice(index, 1);
                    updateSaleTotalOnScreen();
                    renderSaleItems();
                }
            }

            function renderSaleItems() {
                saleItemsList.innerHTML = '';
                emptySaleMessage.style.display = saleItemsArray.length === 0 ? 'block' : 'none';
                saleItemsArray.forEach(item => saleItemsList.appendChild(item.listItemElement));
                if (saleItemsArray.length > 0) saleItemsList.scrollTop = saleItemsList.scrollHeight;
            }

            function updateSaleTotalOnScreen() {
                saleTotalSpan.textContent = currentSaleTotal.toFixed(2).replace('.', ',');
            }

            function clearCurrentSale() {
                saleItemsArray = [];
                currentSaleTotal = 0.00;
                nextSaleItemId = 1;
                renderSaleItems();
                updateSaleTotalOnScreen();
                barcodeInput.focus();
            }

            function handleAddPayment() {
                const methodId = selectedPaymentMethodIdInput.value;
                const selectedButton = paymentMethodButtonsContainer.querySelector(`.payment-method-btn[data-method-id="${methodId}"]`);
                if (!methodId) { alert("Selecione uma forma de pagamento."); return; }
                const amount = parseFloat(paymentAmountInput.value.replace(',', '.'));
                if (isNaN(amount) || amount <= 0) { alert("Insira um valor de pagamento válido."); paymentAmountInput.focus(); return; }
                
                // Validação de cliente para método "Fiado"
                if (selectedButton.dataset.requiresCustomer === 'true' && !selectedCustomerIdInput.value) {
                    alert('Para esta forma de pagamento, é obrigatório selecionar um cliente.');
                    customerSearchInput.focus();
                    return;
                }

                currentPaymentsArray.push({ payment_method_id: methodId, methodName: selectedButton.dataset.methodName, amount: amount.toFixed(2) });
                renderAddedPayments();
                selectedPaymentMethodIdInput.value = '';
                styleSelectedPaymentButton(null);
                const totalPaid = currentPaymentsArray.reduce((acc, p) => acc + parseFloat(p.amount), 0);
                if (totalPaid >= saleTotalForModal) { 
                    confirmSaleWithPaymentsButton.focus(); 
                    paymentAmountInput.value = ''; 
                } else { 
                    paymentAmountInput.value = (saleTotalForModal - totalPaid).toFixed(2).replace('.', ','); 
                    // NOVO: Foca no primeiro botão de pagamento para adicionar o valor restante
                    const firstPaymentButton = paymentMethodButtons[0];
                    if (firstPaymentButton) {
                        firstPaymentButton.focus();
                    }
                }
            }

            function renderAddedPayments() {
                addedPaymentsList.innerHTML = '';
                let totalPaid = 0;
                noPaymentsAddedMsg.style.display = currentPaymentsArray.length === 0 ? 'block' : 'none';
                currentPaymentsArray.forEach((p, index) => {
                    totalPaid += parseFloat(p.amount);
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';
                    li.innerHTML = `<span>${p.methodName}: R$ ${parseFloat(p.amount).toFixed(2).replace('.', ',')}</span><button type="button" class="btn btn-sm btn-outline-danger remove-added-payment-btn" data-index="${index}">X</button>`;
                    addedPaymentsList.appendChild(li);
                });
                updatePaymentModalTotals(totalPaid);
            }

            function updatePaymentModalTotals(totalPaid) {
                const difference = totalPaid - saleTotalForModal;
                modalTotalPaidSpan.textContent = `R$ ${totalPaid.toFixed(2).replace('.', ',')}`;
                modalAmountRemainingSpan.innerHTML = difference >= -0.001 ? `Troco: <span class="text-success">R$ ${difference.toFixed(2).replace('.', ',')}</span>` : `Restante: <span class="text-danger">R$ ${Math.abs(difference).toFixed(2).replace('.', ',')}</span>`;
                confirmSaleWithPaymentsButton.disabled = difference < -0.001;
            }

            function styleSelectedPaymentButton(selectedBtn) {
                paymentMethodButtons.forEach(btn => { btn.classList.remove('btn-primary'); btn.classList.add('btn-outline-primary'); });
                if (selectedBtn) { selectedBtn.classList.remove('btn-outline-primary'); selectedBtn.classList.add('btn-primary'); }
            }

            function finalizeSale() {
                const saleData = {
                    items: saleItemsArray.map(item => ({ productId: item.productId, quantity: item.quantity.toString(), price: item.price.toFixed(2) })),
                    payments: currentPaymentsArray,
                    customer_id: selectedCustomerIdInput.value || null,
                    point_of_sale_id: document.getElementById('pointOfSaleId').value // Adiciona o ID do POS
                };
                fetch("{% url 'sales:finalize_sale' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify(saleData)
                }).then(res => res.json()).then(data => {
                    if (data.status === 'success') { clearCurrentSale(); finalizeSaleModalInstance.hide(); } 
                    else { alert(`Erro: ${data.message || 'Ocorreu um problema.'}`); }
                }).catch(err => { console.error("Erro:", err); alert("Erro de comunicação."); });
            }

            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            const searchCustomers = debounce(function(query) {
                if (query.length < 2) { customerSearchResults.innerHTML = ''; return; }
                fetch(`{% url 'customers:search_customers' %}?q=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        customerSearchResults.innerHTML = '';
                        if (data.length === 0) {
                            customerSearchResults.innerHTML = '<li class="list-group-item">Nenhum cliente encontrado.</li>';
                            return;
                        }
                        data.forEach(customer => {
                            const item = document.createElement('a');
                            item.href = '#';
                            item.className = 'list-group-item list-group-item-action';
                            item.textContent = customer.name;
                            item.dataset.customerId = customer.id;
                            customerSearchResults.appendChild(item);
                        });
                    });
            }, 300);

            // --- Listeners ---
            addProductButton.addEventListener('click', () => {
                const code = barcodeInput.value.trim();
                if (!code) return;
                const product = productsData.find(p => p.barcode === code || p.internal_code === code);
                if (product) { addProductToSale(product); } 
                else { alert(`Produto com código "${code}" não encontrado.`); barcodeInput.select(); }
            });
            barcodeInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); addProductButton.click(); } });
            confirmQuantityButton.addEventListener('click', () => {
                confirmQuantityButton.addEventListener('click', () => {
                const val = parseFloat(quantityInput.value.replace(',', '.'));
                if (!isNaN(val) && val > 0) { 
                    pendingQuantity = val; 
                    currentPendingQuantitySpan.textContent = String(val).replace('.', ','); // Mostra com vírgula na tela principal
                    bootstrap.Modal.getInstance(quantityModalElement).hide(); 
                    barcodeInput.focus(); 
                } 
                else { 
                    alert("Insira uma quantidade válida."); 
                }
            });
            });

            // Foca no input quando o modal de quantidade é aberto
            quantityModalElement.addEventListener('shown.bs.modal', () => {
                quantityInput.focus();
                quantityInput.select(); // Opcional: seleciona o texto atual para fácil substituição
            });

            // Listener unificado para o input de quantidade
            quantityInput.addEventListener('keydown', e => {
                // Permite teclas de controle como Backspace, Tab, setas, etc.
                if (['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Escape'].includes(e.key)) {
                    return;
                }
                
                // Lógica do Enter
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const valueStr = quantityInput.value.replace(',', '.');
                    const val = parseFloat(valueStr);

                    if (!isNaN(val) && val > 0) {
                        pendingQuantity = val;
                        currentPendingQuantitySpan.textContent = String(val).replace('.', ',');
                        bootstrap.Modal.getInstance(quantityModalElement).hide();
                        // Adiciona o produto que já está no campo de código de barras
                        addProductButton.click(); 
                    } else {
                        alert("Insira uma quantidade válida.");
                    }
                    return; // Encerra a execução para o Enter
                }

                // Validação da tecla pressionada
                const currentValue = quantityInput.value;
                const key = e.key;

                // Permite apenas números
                if (!/[0-9]/.test(key) && key !== ',') {
                    e.preventDefault();
                    return;
                }
                // Permite apenas uma vírgula
                if (key === ',' && currentValue.includes(',')) {
                    e.preventDefault();
                }
            });

            // NOVO: Devolve o foco ao input principal quando o modal de quantidade é fechado
            quantityModalElement.addEventListener('hidden.bs.modal', () => {
                barcodeInput.focus();
            });

            // --- Listeners do Modal da Calculadora ---
            (function() {
                const modal = document.getElementById('calculatorModal');
                if (!modal) return;

                const display = modal.querySelector('#calculatorDisplay');
                let currentInput = '0';
                let firstOperand = null;
                let operator = null;

                function formatResult(num) {
                    if (isNaN(num)) return 'Erro';
                    // Arredonda para 12 dígitos significativos para evitar erros de ponto flutuante
                    // e depois converte para Number para remover zeros à direita desnecessários.
                    return String(Number(num.toPrecision(12)));
                }

                function updateDisplay() {
                    const isOperator = ['+', '-', '*', '/'].includes(currentInput);
                    if (isOperator) {
                        display.textContent = currentInput;
                    } else {
                        display.textContent = currentInput.replace('.', ',');
                    }
                }

                function resetCalculator() {
                    currentInput = '0';
                    firstOperand = null;
                    operator = null;
                    updateDisplay();
                }

                function inputDigit(digit) {
                    const isOperator = ['+', '-', '*', '/'].includes(currentInput);
                    if (isOperator || currentInput === '0') {
                        currentInput = digit;
                    } else {
                        if (currentInput.length < 15) {
                            currentInput += digit;
                        }
                    }
                    updateDisplay();
                }

                function inputDecimal() {
                    const isOperator = ['+', '-', '*', '/'].includes(currentInput);
                    if (isOperator) {
                        currentInput = '0.';
                    } else if (!currentInput.includes('.')) {
                        currentInput += '.';
                    }
                    updateDisplay();
                }

                function handleOperator(nextOperator) {
                    if (firstOperand !== null && ['+', '-', '*', '/'].includes(currentInput)) {
                        operator = nextOperator;
                        currentInput = nextOperator;
                        updateDisplay();
                        return;
                    }
                    
                    const inputValue = parseFloat(currentInput.replace(',', '.'));

                    if (operator && firstOperand !== null) {
                        const result = calculate(firstOperand, inputValue, operator);
                        firstOperand = parseFloat(formatResult(result));
                    } else {
                        firstOperand = inputValue;
                    }

                    operator = nextOperator;
                    currentInput = nextOperator;
                    updateDisplay();
                }

                function calculate(a, b, op) {
                    switch (op) {
                        case '+': return a + b;
                        case '-': return a - b;
                        case '*': return a * b;
                        case '/': return b === 0 ? NaN : a / b; // Retorna NaN para erro
                        default: return b;
                    }
                }
                
                function handleEquals() {
                    if (operator === null || firstOperand === null || ['+', '-', '*', '/'].includes(currentInput)) {
                        return;
                    }
                    const secondOperand = parseFloat(currentInput.replace(',', '.'));
                    const result = calculate(firstOperand, secondOperand, operator);
                    
                    currentInput = formatResult(result);

                    operator = null;
                    firstOperand = null;
                    updateDisplay();
                }

                // Listeners de clique
                modal.addEventListener('click', e => {
                    const button = e.target.closest('.calc-btn');
                    if (!button) return;
                    const { action, value } = button.dataset;

                    if (value >= '0' && value <= '9') inputDigit(value);
                    else if (action === 'decimal') inputDecimal();
                    else if (action === 'operator') handleOperator(value);
                    else if (action === 'calculate') handleEquals();
                    else if (action === 'clear') resetCalculator();
                });

                // Listeners de teclado
                modal.addEventListener('keydown', e => {
                    if (e.key >= '0' && e.key <= '9') { e.preventDefault(); inputDigit(e.key); } 
                    else if (e.key === '.' || e.key === ',') { e.preventDefault(); inputDecimal(); } 
                    else if (['+', '-', '*', '/'].includes(e.key)) { e.preventDefault(); handleOperator(e.key); } 
                    else if (e.key === 'Enter' || e.key === '=') { e.preventDefault(); handleEquals(); } 
                    else if (e.key.toLowerCase() === 'c' || e.key === 'Delete' || e.key === 'Backspace') { e.preventDefault(); resetCalculator(); } 
                    else if (e.key === 'Escape') { bootstrap.Modal.getInstance(modal).hide(); }
                });

                modal.addEventListener('shown.bs.modal', () => {
                    modal.focus();
                    resetCalculator();
                });
            })();
            saleItemsList.addEventListener('click', e => {
                const btn = e.target.closest('.remove-sale-item-btn');
                if (btn) { removeSaleItem(parseInt(btn.dataset.removeId, 10)); }
            });
            finalizeSaleButton.addEventListener('click', () => {
                if (saleItemsArray.length === 0) { alert("Não há itens na venda."); return; }
                saleTotalForModal = currentSaleTotal;
                modalSaleTotalSpan.textContent = saleTotalForModal.toFixed(2).replace('.', ',');
                paymentAmountInput.value = saleTotalForModal.toFixed(2).replace('.', ',');
                finalizeSaleModalInstance.show();
            });
            finalizeSaleModalElement.addEventListener('hidden.bs.modal', () => {
                currentPaymentsArray = []; renderAddedPayments(); selectedPaymentMethodIdInput.value = ''; styleSelectedPaymentButton(null);
                customerSelectionArea.style.display = 'none'; customerSearchInput.value = ''; customerSearchResults.innerHTML = ''; selectedCustomerIdInput.value = ''; selectedCustomerNameSpan.textContent = 'Nenhum';
                barcodeInput.focus();
            });
            paymentMethodButtons.forEach((btn, index) => {
                if (index < 9) { btn.innerHTML += ` <span class="badge bg-secondary">${index + 1}</span>`; }
                btn.addEventListener('click', () => {
                    selectedPaymentMethodIdInput.value = btn.dataset.methodId;
                    styleSelectedPaymentButton(btn);
                    customerSelectionArea.style.display = btn.dataset.requiresCustomer === 'true' ? 'block' : 'none';
                    if (btn.dataset.requiresCustomer === 'true') { customerSearchInput.focus(); }
                    else { paymentAmountInput.focus(); paymentAmountInput.select(); }
                });
            });
            addPaymentButton.addEventListener('click', handleAddPayment);

            // NOVO: Valida a entrada de valor para permitir apenas números e vírgula
            paymentAmountInput.addEventListener('input', e => {
                let value = e.target.value;
                value = value.replace(/[^0-9,]/g, '');
                const parts = value.split(',');
                if (parts.length > 2) {
                    value = parts[0] + ',' + parts.slice(1).join('');
                }
                e.target.value = value;
            });

            confirmSaleWithPaymentsButton.addEventListener('click', finalizeSale);
            addedPaymentsList.addEventListener('click', e => {
                const btn = e.target.closest('.remove-added-payment-btn');
                if (btn) { currentPaymentsArray.splice(parseInt(btn.dataset.index, 10), 1); renderAddedPayments(); }
            });
            customerSearchInput.addEventListener('keyup', e => searchCustomers(e.target.value));
            customerSearchResults.addEventListener('click', e => {
                e.preventDefault();
                if (e.target.classList.contains('list-group-item-action')) {
                    selectedCustomerIdInput.value = e.target.dataset.customerId;
                    selectedCustomerNameSpan.textContent = e.target.textContent;
                    customerSearchResults.innerHTML = '';
                    paymentAmountInput.focus();
                }
            });

            // Listener de atalhos (F3, F4, F9 e numéricos no modal)
            document.addEventListener('keydown', e => {
                const activeElement = document.activeElement;
                const isFinalizeModalOpen = finalizeSaleModalInstance && finalizeSaleModalInstance._isShown;
                
                // Atalhos globais que devem funcionar mesmo com inputs focados
                if (e.key === 'F9' && !isFinalizeModalOpen) {
                    e.preventDefault();
                    finalizeSaleButton.click();
                    return;
                }
                if (e.key === 'F4') {
                    e.preventDefault();
                    const quantityModal = bootstrap.Modal.getInstance(quantityModalElement) || new bootstrap.Modal(quantityModalElement);
                    quantityModal.show();
                    return;
                }
                if (e.key === 'F3') {
                    e.preventDefault();
                    const calculatorModal = bootstrap.Modal.getInstance(calculatorModalElement) || new bootstrap.Modal(calculatorModalElement);
                    calculatorModal.show();
                    return;
                }

                // Lógica específica para quando o modal de finalização está aberto
                if (isFinalizeModalOpen) {
                    // Atalhos de Teclas de Função (F) têm prioridade
                    if (e.key === 'F10') {
                        e.preventDefault();
                        if (!confirmSaleWithPaymentsButton.disabled) {
                            confirmSaleWithPaymentsButton.click();
                        }
                        return;
                    }
                    if (e.key === 'F9') {
                        e.preventDefault();
                        addPaymentButton.click();
                        return; // Encerra aqui para não conflitar com outras lógicas
                    }

                    // Lógica para o campo de input de valor
                    if (activeElement.id === 'paymentAmountInput') {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            addPaymentButton.click();
                        }
                        // Permite a digitação normal e encerra
                        return;
                    }
                    
                    // Lógica para o campo de busca de cliente
                    if (activeElement.id === 'customerSearchInput') {
                        // Permite a digitação normal e encerra
                        return;
                    }

                    // Se o foco não estiver em um input, processa atalhos numéricos
                    const key = parseInt(e.key, 10);
                    if (!isNaN(key) && key > 0 && key <= 9) {
                        e.preventDefault();
                        const paymentButton = paymentMethodButtons[key - 1];
                        if (paymentButton) {
                            paymentButton.click();
                        }
                    }
                }
            });

            function getCookie(name) { let v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)'); return v ? v[2] : null; }
            renderSaleItems();
            barcodeInput.focus();
        });
    </script>
</body>
</html>